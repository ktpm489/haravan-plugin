<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <link rel="stylesheet" href="https://raw.githack.com/ktpm489/haravan-plugin/demoV9/contain/css/index.css">
</head>

<body>
  <button class="open-button" onclick="openForm()">Phân tích vấn đề da mặt</button>

  <div class="form-popup" id="myForm">
    <div class="picture-container" id="pictuer-id">
    <p class="file">
      <input type="file" name="file" id="inputImage" />
      <label for="inputImage">Chọn ảnh</label>
    </p>
      <button type="button" class="btn cancel custom" onclick="dislayCamera()" id="cameraBtn">Chụp Ảnh</button>
    </div>
    <div class="contentarea" id="cameraForm">
      <div class="camera">
        <video id="video">Video stream not available.</video>
      </div>
      <div><button id="startbutton">Chụp</button></div>
      <canvas id="canvas"></canvas>
    </div>
    <form action="/" class="form-container" id="subform">
      <img src="https://i.ibb.co/P4pwftk/skin.png" alt="W3Schools.com" id="imageShow">
      <img src="" id="output">
      <button type="button" class="btn upload" onclick="openResult()" id="uploadbtn">Tải lên</button>
      <button type="button" class="btn cancel" onclick="closeForm()">Đóng</button>
    </form>
    <div id="c-placeholder" class="c-placeholder-container"></div>
  </div>
  

  
  <script type="text/javascript">

    function enableBtn() {
      document.getElementById("uploadbtn").disabled = false;
      document.getElementById("uploadbtn").style.opacity = 1;
    }

    function disableBtn() {
      document.getElementById("uploadbtn").disabled = true;
      document.getElementById("uploadbtn").style.opacity = 0.5;
    }

    function includeChooseFileListen() {
      var fileToRead = document.getElementById("inputImage");
      fileToRead.addEventListener(
        "change",
        function (event) {
          // console.log('11111')
          document.getElementById("subform").style.display = "flex";
          document.getElementById("cameraForm").style.display = "none";
          var files = fileToRead.files;
          if (files.length) {
            var img = document.getElementById("imageShow");
            var reader = new FileReader();
            reader.onloadend = function () {
              img.src = reader.result;
            };
            reader.readAsDataURL(files[0]);
            resizeImage(files[0]);
            enableBtn();
          }
        },
        false
      );
    }
    function resizeImage(fileInput) {
      var file = fileInput;
      if (file) {

        var reader = new FileReader();
        // Set the image once loaded into file reader
        reader.onload = function (e) {

          var img = document.createElement("img");
          img.src = e.target.result;

          var canvas = document.createElement("canvas");
          var ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);

          var MAX_WIDTH = 400;
          var MAX_HEIGHT = 400;
          var width = img.width;
          var height = img.height;
          if (width > height) {
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width *= MAX_HEIGHT / height;
              height = MAX_HEIGHT;
            }
          }
          canvas.width = 500;
          canvas.height = 500;
          var ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, 500, 500);
          dataurl = canvas.toDataURL(file.type);
          document.getElementById("output").src = dataurl;
        }
        reader.readAsDataURL(file);

      }
    }

    
    
</script>

<script type="text/javascript">
  function getConfigSkinAI(functionProcess) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = process;
    xhr.open("GET", "https://raw.githubusercontent.com/ktpm489/admin-demo/master/config3.js", true);
    xhr.send();
    function process() {
      if (xhr.readyState == 4) {
        result = JSON.parse(xhr.responseText)
        if (result) {
          functionProcess && functionProcess(result)
        } else {
          // errorShow()
        }

      }
    }
  }
  function errorShow(text = "Vui lòng thử lại") {
    alert(text);
  }
</script>

<script>
   function disableBtn() {
    document.getElementById("uploadbtn").disabled = true;
    document.getElementById("uploadbtn").style.opacity = 0.5;
  }

  function enableBtn() {
    document.getElementById("uploadbtn").disabled = false;
    document.getElementById("uploadbtn").style.opacity = 1;
  }
</script>

<script>
  function renderData(itemInput, idParse = "demo", titleDefault = "") {
    var outputs = "";

    if (itemInput.title !== undefined) {
      outputs += "<div class=" + "title-result" + ">" + itemInput.title.vi + "</div>";
    } else if (titleDefault !== "") {
      outputs += "<div>" + titleDefault + "</div>";
      outputs += "<div>" + "\n" + "</div>";
    }

    for (var i = 0; i < itemInput.data.length; i++) {
      let itemData = itemInput.data[i];
      if (itemData !== null) {
        let itemOutput = "";
        if (itemData.title !== undefined) {
          itemOutput += "<div>" + itemData.title.vi + "</div>";
        }
        {
          itemData.data !== undefined
            ? itemData.data.forEach((item, i) => {
              itemOutput += "<div>" + item.valueVI + "</div>";
            })
            : null;
        }
        {
          itemData.valueEN !== undefined && itemData.valueVI !== undefined
            ? (itemOutput += "<div>" + itemData.valueVI + "</div>")
            : null;
        }

        outputs += "<div>" + itemOutput + "</div>";
        outputs +=
          "<div>" +
          "------------------------------------------------------------------" +
          "</div>";
      }
    }
    document.getElementById(idParse).innerHTML = outputs;
  }

  function renderSpecialData(itemInput, idParse = "demo") {
    var outputs = "";
    if (itemInput.title !== undefined) {
      outputs += "<div class=" + "title-result" + ">" + itemInput.title.vi + "</div>";
    }

    for (let j = 0; j < itemInput.data.length; j++) {
      let tempData = itemInput.data[j];
      for (let k = 0; k < tempData.length; k++) {
        let itemData = tempData[k];
        if (itemData.data !== undefined) {
          if (itemData !== null) {
            outputs += "<div>" + "-------------" + "</div>";
            let itemOutput = "";
            if (itemData.title !== undefined) {
              itemOutput += "<div>" + itemData.title.vi + "</div>";
            }
            {
              itemData.data !== undefined
                ? itemData.data.vi.forEach((item, i) => {
                  itemOutput += "<div>" + item + "</div>";
                })
                : null;
            }
            {
              itemData.valueEN !== undefined && itemData.valueVI !== undefined
                ? (itemOutput += "<div>" + itemData.valueVI + "</div>")
                : null;
            }
            outputs += "<div>" + itemOutput + "</div>";
          }
        }
      }
    }

    document.getElementById(idParse).innerHTML = outputs;
  }

  function renderImg(url) {
    var img = document.getElementById("myimgresult");
    img.src = url;
  }
</script>
<script>

  function closeFunction() {
    document.getElementById("myForm").style.display = "none";
    document.getElementById("subform").style.display = "flex";
    document.getElementById("pictuer-id").style.display = "flex";
    document.getElementById("c-placeholder").style.display = "none";
    document.getElementById("imageShow").src =
      "https://i.ibb.co/P4pwftk/skin.png";
    document.getElementById("output").src = "";
    document.getElementById("inputImage").value = "";
    disableBtn()
  }

  function renderDivItem(itemId, data, taux = 1, color = "red") {
    var div = document.createElement("div");
    // let screenWidth = screen.width 
    // let taux = screenWidth > 767 ? 1 : (screenWidth-26)/640
    div.style.width = data.width * taux + "px";
    div.style.height = data.height * taux + "px";
    div.style.top = data.top * taux + "px";
    div.style.left = data.left * taux + "px";
    div.style.color = color;
    div.style.borderColor = color;
    div.className = "box";
    let el = document.getElementById(itemId);
    el.appendChild(div);
  }

  function drawData(arr, itemId, color = "red", taux = 1) {
    if (arr.length > 0) {
      for (var i = 0; i < arr.length; i++) {
        renderDivItem(itemId, arr[i], taux, color);
      }
    }
  }

</script>
<script>
  function myFunction(toogleId, containerId) {
    var checkBox = document.getElementById(toogleId);
    var text = document.getElementById(containerId);
    if (checkBox.checked == true) {
      text.style.display = "block";
    } else {
      text.style.display = "none";
    }
  }
</script>
<script>

  function resizeImageCapture(data) {
    var canvas = document.createElement("canvas");
    var ctx = canvas.getContext("2d");

    canvas.width = 500; // target width
    canvas.height = 500; // target height
    var image = new Image();
    image.onload = function (e) {
      ctx.drawImage(image,
        0, 0, image.width, image.height,
        0, 0, canvas.width, canvas.height
      );
      document.getElementById("output").src = canvas.toDataURL();
    };
    image.src = data;
  }

  

  function processGeneralConclusion(dataTransfer) {
    let drawMoleArrDataInput = [];
    for (let i = 0; i < dataTransfer.generalResult.data.length; i++) {
      let itemData = dataTransfer.generalResult.data[i];
      for (let j = 0; j < itemData.data.length; j++) {
        let eachData = itemData.data[j];
        if (eachData.key === "SkinMole") {
          drawMoleArrDataInput = eachData.drawArr;
        }
      }
    }
    drawData(drawMoleArrDataInput, "moleContainer", "red");
  }

  function processSpecialResult(dataTransfer) {
    let drawSpotArrDataInput = [];
    let drawBlackHeadArrDataInput = [];
    let drawAcneArrDataInput = [];
    let drawPimpleArrDataInput = [];
    // console.log('dataTransfer', dataTransfer)
    for (let i = 0; i < dataTransfer.specialResult.data.length; i++) {
      let itemData = dataTransfer.specialResult.data[i];
      for (let j = 0; j < itemData.data.length; j++) {
        let eachData = itemData.data[j];
        if (eachData.key === "SkinBlackHeads") {
          drawBlackHeadArrDataInput = eachData.drawArr;
        } else if (eachData.key === "SkinSpot") {
          drawSpotArrDataInput = eachData.drawArr;
        } else if (eachData.key === "SkinPimple") {
          drawPimpleArrDataInput = eachData.drawArr;
        } else if (eachData.key === "SkinAcne") {
          drawAcneArrDataInput = eachData.drawArr;
        }
      }
    }
    let screenWidth = screen.width
    let taux = screenWidth > 767 ? 1 : (screenWidth - 26) / dataTransfer.image_info.width
    drawData(drawBlackHeadArrDataInput, "blackHeadContainer", "pink", taux);
    drawData(drawSpotArrDataInput, "spotContainer", "orange", taux);
    drawData(drawPimpleArrDataInput, "pimpleContainer", "green", taux);
    drawData(drawAcneArrDataInput, "acneContainer", "yellow", taux);
  }

 


  function renderSkinData(dataJSON) {
    renderData(dataJSON.data.facedata.generalResult, "generalResult");
    renderData(
      dataJSON.data.facedata.specialResult,
      "specialResult",
      "Kết quả từng phần"
    );
    renderData(dataJSON.data.facedata.generalConclusion, "generalConclusion");
    renderSpecialData(
      dataJSON.data.facedata.specialConclusion,
      "specialConclusion"
    );
    renderImg(dataJSON.data.facedata.image_info.url);
    processSpecialResult(dataJSON.data.facedata);
    processGeneralConclusion(dataJSON.data.facedata);
  }

  function openRenderPage() {
    document.getElementById("subform").style.display = "none";
    document.getElementById("pictuer-id").style.display = "none";
    document.getElementById("c-placeholder").style.display = "block";
    document.getElementById("uploadbtn").innerHTML = "Tải lên";
  }
</script>
<script>
 
  
 var width = 320; // We will scale the photo width to this
  var height = 0; // This will be computed based on the input stream
  var streaming = false;
  var video = null;
  var canvas = null;
  var photo = null;
  var startbutton = null;
  var localstream = null;
  
  function clearphoto() {
    try {
    var context = canvas.getContext("2d");
    context.fillStyle = "#AAA";
    context.fillRect(0, 0, canvas.width, canvas.height);
    var data = canvas.toDataURL("image/png");
    photo = document.getElementById("imageShow");
    photo.setAttribute("src", data);
    } catch(e) {

    }
   
  }

  
  function startup() {
  
  video = document.getElementById("video");
  canvas = document.getElementById("canvas");
  photo = document.getElementById("imageShow");
  startbutton = document.getElementById("startbutton");

  navigator.mediaDevices
    .getUserMedia({
      video: true,
      audio: false,
    })
    .then(function (stream) {
      video.srcObject = stream;
      localstream = stream;
      video.play();
    })
    .catch(function (err) {
      console.log("An error occurred: " + err);
    });

  video.addEventListener(
    "canplay",
    function (ev) {
      if (!streaming) {
        height = video.videoHeight / (video.videoWidth / width);

        if (isNaN(height)) {
          height = width / (4 / 3);
        }

        video.setAttribute("width", width);
        video.setAttribute("height", height);
        canvas.setAttribute("width", width);
        canvas.setAttribute("height", height);
        streaming = true;
      }
    },
    false
  );

  console.log('width', width, height, canvas)
  startbutton.addEventListener(
    "click",
    function (ev) {
      // console.log('width', width, height, canvas)
      takepicture();
      ev.preventDefault();
    },
    false
  );

  clearphoto();
}
 

  function videoOff() {
    // A video"s MediaStream object is available through its srcObject attribute
    video = document.getElementById("video");
    const mediaStream = video.srcObject;
    // Through the MediaStream, you can get the MediaStreamTracks with getTracks():
    const tracks = mediaStream.getTracks();
    // Tracks are returned as an array, so if you know you only have one, you can stop it with:
    // tracks[0].pause();

    // Or stop all like so:
    tracks.forEach((track) => track.stop());
  }


  function takepicture() {
    var context = canvas.getContext("2d");
    photo = document.getElementById("imageShow");
    if (width && height) {
      canvas.width = width;
      canvas.height = height;
      context.drawImage(video, 0, 0, width, height);
      var data = canvas.toDataURL("image/png");
      photo.setAttribute("src", data);
      document.getElementById("subform").style.display = "flex";
      document.getElementById("cameraForm").style.display = "none";
      document.getElementById("c-placeholder").style.display = "none";
      // draw render output image
      resizeImageCapture(data)
      enableBtn();
    } else {
      clearphoto();
      document.getElementById("subform").style.display = "flex";
      document.getElementById("cameraForm").style.display = "none";
      document.getElementById("c-placeholder").style.display = "none";
    }
    setTimeout(() => {
      videoOff();
    }, 1500);
  }

  

  

  function resizeImage(fileInput) {
    var file = fileInput;
    if (file) {

      var reader = new FileReader();
      // Set the image once loaded into file reader
      reader.onload = function (e) {

        var img = document.createElement("img");
        img.src = e.target.result;

        canvas = document.createElement("canvas");
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        var MAX_WIDTH = 400;
        var MAX_HEIGHT = 400;
        var width = img.width;
        var height = img.height;
        if (width > height) {
          if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
          }
        } else {
          if (height > MAX_HEIGHT) {
            width *= MAX_HEIGHT / height;
            height = MAX_HEIGHT;
          }
        }
        canvas.width = 500;
        canvas.height = 500;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, 500, 500);
        dataurl = canvas.toDataURL(file.type);
        document.getElementById("output").src = dataurl;
      }
      reader.readAsDataURL(file);

    }
  }

</script>
<script>

  
  function resetFistPageData(show = true) {
    document.getElementById("myForm").style.display = show ? "block" : "none";
    document.getElementById("subform").style.display = "flex";
    document.getElementById("pictuer-id").style.display = "flex";
    document.getElementById("c-placeholder").style.display = "none";
    document.getElementById("uploadbtn").innerHTML = "Tải lên";
    document.getElementById("imageShow").src =
      "https://i.ibb.co/P4pwftk/skin.png";
    document.getElementById("output").src = "";
    document.getElementById("inputImage").value = "";
    disableBtn()
  }

  function processImage(inputData) {
    // var img = document.getElementById("output");
    var img = document.getElementById("imageShow");
    // console.log("inputData", inputData.configSkin.email)
    try {
      if (img.src !== null) {
        let dataInput = img.src
        let jdata = {
          email: inputData.configSkin.email,
          image_base64: dataInput.substr(dataInput.indexOf("base64,") + 7) + "",
        };
        // alert(jdata.image_base64)
        var xhttp = new XMLHttpRequest();
        xhttp.open(
          "POST",
          inputData.configSkin.link,
          true
        );
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.setRequestHeader(
          "apikey",
          inputData.configSkin.key
        );
        xhttp.send(JSON.stringify(jdata));

        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            if (this.status === 200) {
              console.log(this.responseText);
              let dataJSON = JSON.parse(this.responseText);
              renderSkinData(dataJSON);
              openRenderPage();
            } else {
              // alert('1')
              // errorShow();
              resetFistPageData();
            }
          } else if (this.status == 400) {
            // alert('2')
            // alert(this.responseText)
            // errorShow();
            resetFistPageData();
          }
        };
      }
    } catch (e) {
      // errorShow();
      // alert(3);
      resetFistPageData();
    }
  }


  function uploadImage() {
    getConfigSkinAI(processImage);
  }
  function dislayCamera() {
    document.getElementById("subform").style.display = "none";
    document.getElementById("cameraForm").style.display = "block";
    startup();
  }

 
  
</script>


  <script>
    $(function () {
      $("#c-placeholder").load("https://raw.githack.com/ktpm489/haravan-plugin/demoV9/contain/result.html");
      // $("#c-placeholder").load("./contain/result.html");
    });

    $(function () {
      if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
        document.getElementById("cameraBtn").style.display = "none";
    } else {
      // console.log("fff")
    }
    });

    $(function () {
      includeChooseFileListen();
       disableBtn();
    });

  </script>
  <script>
    function openForm() {
      document.getElementById("myForm").style.display = "block";
    }

    function closeForm() {
      resetFistPageData(false)
    }

    function openResult () {
      document.getElementById("uploadbtn").innerHTML = "Tải lên...";
      uploadImage()
      
    }
  </script>
  

</body>

</html>