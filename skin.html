<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/javascript" src="./js/skin.js"></script>
  <script type="text/javascript" src="./js/jquery-1.10.2.js"></script>
  <link rel="stylesheet" href="./css/index.css">
</head>

<body>
  <button class="open-button" onclick="openForm()">Scan Skin AI</button>

  <div class="form-popup" id="myForm">
    <div class='picture-container'>
      <input type="file" id="inputImage">
      <button type="button" class="btn cancel" onclick="dislayCamera()">Take picture</button>
    </div>
    <div class="contentarea" id="cameraForm">
      <div class="camera">
        <video id="video">Video stream not available.</video>
      </div>
      <div><button id="startbutton">Take photo</button></div>
      <canvas id="canvas"></canvas>
      <div class="output">
        <img id="photo" alt="The screen capture will appear in this box.">
      </div>
    </div>
    <form action="/" class="form-container" id='subform'>
      <img src="https://www.w3schools.com/images/w3schools_green.jpg" alt="W3Schools.com" id="imageShow">
      <button type="submit" class="btn">Upload</button>
      <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
    </form>
  </div>

  <script>
    function openForm() {
      document.getElementById("myForm").style.display = "block";
    }

    function closeForm() {
      document.getElementById("myForm").style.display = "none";
    }
  </script>

  <script>
    /* JS comes here */
    (function () {

      var width = 320; // We will scale the photo width to this
      var height = 0; // This will be computed based on the input stream

      var streaming = false;
      var video = null;
      var canvas = null;
      var photo = null;
      var startbutton = null;
      var localstream = null;
      function startup() {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        // photo = document.getElementById('photo');
        photo = document.getElementById('imageShow');
        startbutton = document.getElementById('startbutton');

        navigator.mediaDevices.getUserMedia({
          video: true,
          audio: false
        })
          .then(function (stream) {
            video.srcObject = stream;
            localstream = stream;
            video.play();
          })
          .catch(function (err) {
            console.log("An error occurred: " + err);
          });

        video.addEventListener('canplay', function (ev) {
          if (!streaming) {
            height = video.videoHeight / (video.videoWidth / width);

            if (isNaN(height)) {
              height = width / (4 / 3);
            }

            video.setAttribute('width', width);
            video.setAttribute('height', height);
            canvas.setAttribute('width', width);
            canvas.setAttribute('height', height);
            streaming = true;
          }
        }, false);

        startbutton.addEventListener('click', function (ev) {
          takepicture();
          ev.preventDefault();
        }, false);

        clearphoto();
      }


      function clearphoto() {
        var context = canvas.getContext('2d');
        context.fillStyle = "#AAA";
        context.fillRect(0, 0, canvas.width, canvas.height);

        var data = canvas.toDataURL('image/png');
        photo.setAttribute('src', data);
      }

      function takepicture() {
        var context = canvas.getContext('2d');
        if (width && height) {
          canvas.width = width;
          canvas.height = height;
          context.drawImage(video, 0, 0, width, height);
          var data = canvas.toDataURL('image/png');
          photo.setAttribute('src', data);
          document.getElementById("subform").style.display = "block";
          document.getElementById("cameraForm").style.display = "none";
          videoOff();
        } else {
          clearphoto();
          document.getElementById("subform").style.display = "block";
          document.getElementById("cameraForm").style.display = "none";
        }
      }

      function videoOff() {
        // A video's MediaStream object is available through its srcObject attribute
        const mediaStream = video.srcObject;

        // Through the MediaStream, you can get the MediaStreamTracks with getTracks():
        const tracks = mediaStream.getTracks();

        // Tracks are returned as an array, so if you know you only have one, you can stop it with: 
        tracks[0].stop();

        // Or stop all like so:
        tracks.forEach(track => track.stop())
      }


      window.addEventListener('load', startup, false);
    })();
  </script>
  <script>
    includeChooseFileListen();
  </script>
  <script>
    fetch("https://ipinfo.io/json")
      .then(function (response) {
        return response.json();
      })
      .then(function (myJson) {
        console.log(myJson.ip);
      })
      .catch(function (error) {
        console.log("Error: " + error);
      });
  </script>

  <script>
    $(function () {
      // $("#c-placeholder").load("result.html");
    });
  </script>

</body>

</html>